name: Docker Image Sync to Aliyun

on:
  workflow_dispatch:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 (å³åŒ—äº¬æ—¶é—´ 08:00) è¿è¡Œ
    - cron: '0 */12 * * *'
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
  WEBHOOK_URL: "${{ secrets.WEBHOOK_URL }}" # åœ¨ Secrets ä¸­é…ç½®é£ä¹¦æˆ–ä¼å¾®åœ°å€

jobs:
  build:
    name: Sync Images
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    
    steps:
      # 1. éªŒè¯è¿è¡Œå™¨ç¯å¢ƒ
      - name: éªŒè¯è¿è¡Œå™¨ç¯å¢ƒ
        run: |
          echo "=== è¿è¡Œå™¨ç¯å¢ƒæŠ¥å‘Š ==="
          echo "è¿è¡Œå™¨ç¯å¢ƒï¼š${{ runner.environment }}"
          echo "è¿è¡Œå™¨åç§°ï¼š${{ runner.name }}"
          echo "è¿è¡Œå™¨æ ‡ç­¾ï¼š${{ toJson(runner.labels) }}"
          
          # å†³å®šæ€§æ£€æŸ¥ï¼šå¦‚æœæ˜¯è‡ªæ‰˜ç®¡ç¯å¢ƒï¼Œç«‹å³å¤±è´¥
          if [ "${{ runner.environment }}" == "self-hosted" ]; then
            echo "âŒ ä¸¥é‡é”™è¯¯ï¼šæ£€æµ‹åˆ°è‡ªæ‰˜ç®¡è¿è¡Œå™¨ (self-hosted)ã€‚"
            echo "è¿™æ„å‘³ç€æ‚¨çš„ 'ubuntu-latest' æ ‡ç­¾ä»è¢«æŸä¸ªè‡ªæ‰˜ç®¡è¿è¡Œå™¨åŒ¹é…ã€‚"
            echo "è¯·ç«‹å³æ£€æŸ¥å¹¶åˆ é™¤æ‚¨è´¦æˆ·ä¸‹æ ‡è®°ä¸º 'ubuntu-latest' çš„è‡ªæ‰˜ç®¡è¿è¡Œå™¨ã€‚"
            exit 1
          fi
          
          echo "âœ… å½“å‰è¿è¡Œäº GitHub æ‰˜ç®¡çš„è¿è¡Œå™¨ (${{ runner.os }})ã€‚"
          echo "å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"
          echo "å¯ç”¨ç£ç›˜ç©ºé—´ï¼š"
          df -h
      
      # 2. æ£€å‡ºä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # 3. å®‰è£…å¿…éœ€å·¥å…·
      - name: Install required tools
        run: |
          echo "=== å®‰è£…å¿…éœ€å·¥å…· ==="
          sudo apt-get update
          sudo apt-get install -y skopeo jq
          echo "âœ… skopeo ç‰ˆæœ¬: $(skopeo --version)"
          echo "âœ… jq ç‰ˆæœ¬: $(jq --version)"
      
      # 4. æœ€å¤§åŒ–æ„å»ºç©ºé—´
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: 'true'
          remove-haskell: 'true'
          build-mount-path: '/var/lib/docker/'
      
      # 5. é‡å¯ Docker
      - name: Restart docker
        run: |
          echo "=== é‡å¯ Docker æœåŠ¡ ==="
          sudo service docker restart
          sleep 5
          docker info
      
      # 6. åŒæ­¥é•œåƒåˆ°é˜¿é‡Œäº‘ (ä¿®å¤ ACR Digest é—®é¢˜)
      - name: Sync and Push to Aliyun
        id: sync_step
        run: |
          echo "=== å¼€å§‹åŒæ­¥é•œåƒåˆ°é˜¿é‡Œäº‘ ==="
          
          # ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
          echo "$ALIYUN_REGISTRY_PASSWORD" | docker login -u "$ALIYUN_REGISTRY_USER" --password-stdin "$ALIYUN_REGISTRY"
          
          SYNC_SUMMARY=""
          SUCCESS_COUNT=0
          FAILURE_COUNT=0
          SKIP_COUNT=0
          
          # ç¬¬ä¸€æ­¥ï¼šé¢„å¤„ç†ï¼Œæ‰¾å‡ºé‡åé•œåƒ
          echo "=== é¢„å¤„ç†ï¼šæ£€æµ‹é‡åé•œåƒ ==="
          declare -A duplicate_images
          declare -A temp_map
          
          while IFS= read -r line || [ -n "$line" ]; do
              # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
              [[ -z "$line" ]] && continue
              if echo "$line" | grep -q '^\s*#'; then
                  continue
              fi
              
              # è·å–é•œåƒçš„å®Œæ•´åç§°
              raw_image=$(echo "$line" | awk '{print $NF}')
              # ç§»é™¤ @sha256: ç­‰æ‘˜è¦ä¿¡æ¯
              image="${raw_image%%@*}"
              # è·å–é•œåƒå:ç‰ˆæœ¬å· ä¾‹å¦‚ nginx:1.25.3
              image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
              # è·å–å‘½åç©ºé—´
              name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
              
              # å¦‚æœå‘½åç©ºé—´ä¸ºç©ºï¼Œä½¿ç”¨ç‰¹å®šæ ‡è®°
              if [[ -z "$name_space" ]]; then
                  name_space="library"
              fi
              
              # è·å–é•œåƒåï¼ˆä¸å«æ ‡ç­¾ï¼‰ä¾‹å¦‚ nginx
              image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
              
              # å¦‚æœé•œåƒå­˜åœ¨äºæ•°ç»„ä¸­ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦æœ‰é‡åå†²çª
              if [[ -n "${temp_map[$image_name]}" ]]; then
                   # å¦‚æœ temp_map å·²ç»å­˜åœ¨é•œåƒåï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯åŒä¸€å‘½åç©ºé—´
                   if [[ "${temp_map[$image_name]}" != "$name_space" ]]; then
                      duplicate_images[$image_name]="true"
                   fi
              else
                  # å­˜é•œåƒçš„å‘½åç©ºé—´
                  temp_map[$image_name]="$name_space"
              fi
          done < images.txt
          
          echo "âœ… é¢„å¤„ç†å®Œæˆï¼Œå‘ç° ${#duplicate_images[@]} ä¸ªé‡åé•œåƒ"
          
          # ç¬¬äºŒæ­¥ï¼šæ‰§è¡ŒåŒæ­¥
          echo "=== å¼€å§‹åŒæ­¥é•œåƒ ==="
          line_number=0
          
          while IFS= read -r line || [ -n "$line" ]; do
              line_number=$((line_number + 1))
              
              # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
              [[ -z "$line" ]] && continue
              if echo "$line" | grep -q '^\s*#'; then
                  echo "ğŸ“ ç¬¬ $line_number è¡Œ: è·³è¿‡æ³¨é‡Šè¡Œ"
                  continue
              fi
              
              echo "--- å¤„ç†ç¬¬ $line_number è¡Œ ---"
              
              # è·å–åŸå§‹é•œåƒä¿¡æ¯
              raw_image=$(echo "$line" | awk '{print $NF}')
              # ç§»é™¤ @sha256: ç­‰æ‘˜è¦ä¿¡æ¯
              image="${raw_image%%@*}"
              
              # è·å–é•œåƒå:ç‰ˆæœ¬å· ä¾‹å¦‚ nginx:1.25.3
              image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
              # è·å–å‘½åç©ºé—´
              name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
              
              # å¦‚æœå‘½åç©ºé—´ä¸ºç©ºï¼Œä½¿ç”¨ç‰¹å®šæ ‡è®°
              if [[ -z "$name_space" ]]; then
                  name_space="library"
              fi
              
              # è·å–é•œåƒåï¼ˆä¸å«æ ‡ç­¾ï¼‰ä¾‹å¦‚ nginx
              image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
              
              # æå–å¹³å°æ¶æ„ä¿¡æ¯
              platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
              
              # å¦‚æœå­˜åœ¨æ¶æ„ä¿¡æ¯ï¼Œå°†æ¶æ„ä¿¡æ¯æ‹¼åˆ°é•œåƒåç§°å‰é¢
              if [ -z "$platform" ]; then
                  platform_prefix=""
              else
                  platform_prefix="${platform//\//_}_"
              fi
              
              name_space_prefix=""
              # å¦‚æœé•œåƒåé‡åä¸”å‘½åç©ºé—´ä¸åŒ
              if [[ -n "${duplicate_images[$image_name]}" ]]; then
                 # å¦‚æœå‘½åç©ºé—´éç©ºï¼Œå°†å‘½åç©ºé—´åŠ åˆ°å‰ç¼€
                 name_space_prefix="${name_space}_"
              fi
              
              # æ„é€ ç›®æ ‡é•œåƒåç§°
              new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$platform_prefix$name_space_prefix$image_name_tag"
              
              echo "åŸå§‹é•œåƒ: $image"
              echo "ç›®æ ‡é•œåƒ: $new_image"
              echo "å¹³å°æ¶æ„: ${platform:-é»˜è®¤}"
              echo "å‘½åç©ºé—´: $name_space"
              echo "é‡åå¤„ç†: ${duplicate_images[$image_name]:+æ˜¯ (ä½¿ç”¨å‰ç¼€)}"
              
              # ========== æ£€æŸ¥é•œåƒæ˜¯å¦éœ€è¦æ›´æ–° ==========
              echo "æ£€æŸ¥é•œåƒçŠ¶æ€..."
              
              # 1. æ£€æŸ¥ç›®æ ‡é•œåƒæ˜¯å¦å­˜åœ¨
              echo "æ£€æŸ¥ç›®æ ‡é•œåƒæ˜¯å¦å­˜åœ¨..."
              if skopeo inspect docker://$new_image --creds "$ALIYUN_REGISTRY_USER:$ALIYUN_REGISTRY_PASSWORD" > /dev/null 2>&1; then
                  # 2. è·å–æºé•œåƒçš„ Config.Digestï¼ˆæ¯” .Digest æ›´ç¨³å®šï¼‰
                  echo "è·å–æºé•œåƒConfig.Digest..."
                  SRC_CONFIG_DIGEST=""
                  if ! SRC_CONFIG_DIGEST=$(skopeo inspect docker://$image --format '{{.Config.Digest}}' 2>/dev/null); then
                      echo "âŒ æ— æ³•è·å–æºé•œåƒConfig.Digestï¼Œè·³è¿‡æ­¤é•œåƒ"
                      SYNC_SUMMARY="${SYNC_SUMMARY}\nâš ï¸ $image_name_tag (æ— æ³•è·å–æºé•œåƒConfig.Digest)"
                      FAILURE_COUNT=$((FAILURE_COUNT + 1))
                      continue
                  fi
                  
                  echo "  æºé•œåƒConfig.Digest: ${SRC_CONFIG_DIGEST:0:32}..."
                  
                  # 3. è·å–ç›®æ ‡é•œåƒçš„ Config.Digest
                  echo "è·å–ç›®æ ‡é•œåƒConfig.Digest..."
                  TARGET_CONFIG_DIGEST=""
                  if ! TARGET_CONFIG_DIGEST=$(skopeo inspect docker://$new_image --creds "$ALIYUN_REGISTRY_USER:$ALIYUN_REGISTRY_PASSWORD" --format '{{.Config.Digest}}' 2>/dev/null); then
                      echo "âŒ æ— æ³•è·å–ç›®æ ‡é•œåƒConfig.Digestï¼Œéœ€è¦åŒæ­¥"
                  else
                      echo "  ç›®æ ‡é•œåƒConfig.Digest: ${TARGET_CONFIG_DIGEST:0:32}..."
                      
                      # 4. æ¯”è¾ƒ Config.Digest
                      if [ "$SRC_CONFIG_DIGEST" = "$TARGET_CONFIG_DIGEST" ]; then
                          echo "âœ… ç›®æ ‡é•œåƒConfig.Digestç›¸åŒï¼Œè·³è¿‡: $image_name_tag"
                          SYNC_SUMMARY="${SYNC_SUMMARY}\nâ­ï¸ $image_name_tag (å·²æ˜¯æœ€æ–°ç‰ˆæœ¬)"
                          SKIP_COUNT=$((SKIP_COUNT + 1))
                          echo ""
                          continue
                      else
                          echo "ğŸ”„ Config.Digestä¸åŒï¼Œéœ€è¦åŒæ­¥: $image_name_tag"
                          echo "  æºConfig.Digest: $SRC_CONFIG_DIGEST"
                          echo "  ç›®æ ‡Config.Digest: $TARGET_CONFIG_DIGEST"
                      fi
                  fi
              else
                  echo "ğŸ”„ ç›®æ ‡é•œåƒä¸å­˜åœ¨ï¼Œéœ€è¦åŒæ­¥: $image_name_tag"
              fi
              # ========== æ£€æŸ¥ç»“æŸ ==========
              
              echo "å¼€å§‹åŒæ­¥é•œåƒ..."
              
              # æ‰§è¡ŒåŒæ­¥ï¼ˆå¸¦è¶…æ—¶å’Œè¯¦ç»†æ—¥å¿—ï¼‰
              # 1. æ‹‰å–é•œåƒ
              echo "æ­¥éª¤ 1/3: æ‹‰å–æºé•œåƒ..."
              if timeout 300 docker pull "$image"; then
                  echo "  âœ… æ‹‰å–æˆåŠŸ"
                  
                  # 2. é‡æ–°æ ‡è®°é•œåƒ
                  echo "æ­¥éª¤ 2/3: é‡æ–°æ ‡è®°é•œåƒ..."
                  if docker tag "$image" "$new_image"; then
                      echo "  âœ… é‡æ ‡è®°æˆåŠŸ"
                      
                      # 3. æ¨é€åˆ°é˜¿é‡Œäº‘
                      echo "æ­¥éª¤ 3/3: æ¨é€åˆ°é˜¿é‡Œäº‘..."
                      if timeout 600 docker push "$new_image"; then
                          echo "  âœ… æ¨é€æˆåŠŸ"
                          
                          # æ¸…ç†æœ¬åœ°é•œåƒ
                          docker rmi "$image" "$new_image" 2>/dev/null || true
                          docker system prune -f 2>/dev/null || true
                          
                          SYNC_SUMMARY="${SYNC_SUMMARY}\nâœ¨ $image_name_tag"
                          SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                          echo "âœ… åŒæ­¥å®Œæˆ: $image_name_tag"
                      else
                          echo "  âŒ æ¨é€å¤±è´¥"
                          SYNC_SUMMARY="${SYNC_SUMMARY}\nğŸš¨ $image_name_tag (æ¨é€å¤±è´¥)"
                          FAILURE_COUNT=$((FAILURE_COUNT + 1))
                      fi
                  else
                      echo "  âŒ é‡æ ‡è®°å¤±è´¥"
                      SYNC_SUMMARY="${SYNC_SUMMARY}\nğŸš¨ $image_name_tag (é‡å‘½åå¤±è´¥)"
                      FAILURE_COUNT=$((FAILURE_COUNT + 1))
                  fi
              else
                  echo "  âŒ æ‹‰å–å¤±è´¥"
                  SYNC_SUMMARY="${SYNC_SUMMARY}\nğŸš¨ $image_name_tag (æ‹‰å–å¤±è´¥)"
                  FAILURE_COUNT=$((FAILURE_COUNT + 1))
              fi
              
              echo ""
          done < images.txt
          
          echo "=== åŒæ­¥å®Œæˆ ==="
          echo "æˆåŠŸ: $SUCCESS_COUNT, è·³è¿‡: $SKIP_COUNT, å¤±è´¥: $FAILURE_COUNT"
          
          # å†™å…¥ç¯å¢ƒå˜é‡
          echo "SUCCESS_COUNT=$SUCCESS_COUNT" >> $GITHUB_ENV
          echo "FAILURE_COUNT=$FAILURE_COUNT" >> $GITHUB_ENV
          echo "SKIP_COUNT=$SKIP_COUNT" >> $GITHUB_ENV
          {
            echo 'SYNC_RESULT<<EOF'
            if [ -n "$SYNC_SUMMARY" ]; then
                echo -e "$SYNC_SUMMARY"
            else
                echo "æœ¬æ¬¡æ²¡æœ‰éœ€è¦åŒæ­¥çš„æ–°é•œåƒ"
            fi
            echo 'EOF'
          } >> $GITHUB_ENV
      
      # 7. æ¸…ç† Docker ç³»ç»Ÿ
      - name: Clean up Docker system
        if: always()
        run: |
          echo "=== æ¸…ç† Docker ç³»ç»Ÿ ==="
          docker system prune -af 2>/dev/null || true
          docker builder prune -af 2>/dev/null || true
          echo "âœ… æ¸…ç†å®Œæˆ"
          echo "å‰©ä½™ç£ç›˜ç©ºé—´:"
          df -h
      
      # 8. å‘é€ Webhook é€šçŸ¥
      - name: å‘é€ Webhook é€šçŸ¥
        if: always()
        run: |
          if [ -z "${{ secrets.WEBHOOK_URL }}" ]; then
            echo "âš ï¸ æœªé…ç½® Webhook URLï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          S_COUNT=${{ env.SUCCESS_COUNT }}
          F_COUNT=${{ env.FAILURE_COUNT }}
          K_COUNT=${{ env.SKIP_COUNT }}
          
          # 1. åˆ¤å®šæ ‡é¢˜å’Œä¸»çŠ¶æ€
          if [ "$F_COUNT" -gt 0 ]; then
              TITLE="âŒ é˜¿é‡Œäº‘é•œåƒåŒæ­¥å¤±è´¥"
              CONTENT="âš ï¸ è­¦å‘Šï¼šæœ‰ $F_COUNT ä¸ªé•œåƒåŒæ­¥å‡ºç°å¼‚å¸¸ï¼Œè¯·åŠæ—¶æ£€æŸ¥ã€‚"
          elif [ "$S_COUNT" -gt 0 ]; then
              TITLE="âœ… é˜¿é‡Œäº‘é•œåƒåŒæ­¥æˆåŠŸ"
              CONTENT="æœ¬æ¬¡æ–°å¢åŒæ­¥é•œåƒå¦‚ä¸‹ï¼š"
          elif [ "$K_COUNT" -gt 0 ]; then
              TITLE="â­ï¸ åŒæ­¥ä»»åŠ¡å®Œæˆ (é•œåƒå·²æ˜¯æœ€æ–°)"
              CONTENT="æ‰€æœ‰é•œåƒå·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€åŒæ­¥ã€‚"
          else
              TITLE="â˜• åŒæ­¥ä»»åŠ¡å®Œæˆ (æ— é•œåƒéœ€è¦å¤„ç†)"
              CONTENT="æ£€æµ‹åˆ° images.txt ä¸­æ— æœ‰æ•ˆé•œåƒéœ€è¦å¤„ç†ã€‚"
          fi
          
          # 2. ç»„è£…æœ€ç»ˆæ–‡æœ¬
          RAW_TEXT=$(cat <<EOF
          $TITLE
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          $CONTENT
          ${{ env.SYNC_RESULT }}
          
          ğŸ“Š ç»Ÿè®¡: æˆåŠŸ $S_COUNT | è·³è¿‡ $K_COUNT | å¤±è´¥ $F_COUNT
          ğŸ“… æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          ğŸ”— è¯¦æƒ…: [æŸ¥çœ‹ GitHub Action æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )
          
          # 3. å‘é€é€šçŸ¥
          echo "å‘é€ Webhook é€šçŸ¥..."
          JSON_PAYLOAD=$(jq -n --arg msg "$RAW_TEXT" '{"msg_type":"text","content":{"text":$msg}}')
          
          # å°è¯•å‘é€ï¼Œæœ€å¤šé‡è¯•3æ¬¡
          for i in {1..3}; do
              if curl -s -X POST -H "Content-Type: application/json" \
                 -d "$JSON_PAYLOAD" \
                 -w "HTTP Status: %{http_code}" \
                 "${{ secrets.WEBHOOK_URL }}" > /dev/null 2>&1; then
                  echo "âœ… é€šçŸ¥å‘é€æˆåŠŸ (å°è¯• $i æ¬¡)"
                  break
              else
                  echo "âš ï¸ é€šçŸ¥å‘é€å¤±è´¥ï¼Œç¬¬ $i æ¬¡å°è¯•"
                  sleep 2
              fi
          done
