name: Docker Image Sync to Aliyun

on:
  workflow_dispatch:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 (å³åŒ—äº¬æ—¶é—´ 08:00) è¿è¡Œ
    - cron: '0 */12 * * *'
  push:
    branches: [ main ]
    paths:
      - 'images.txt'

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
  WEBHOOK_URL: "${{ secrets.WEBHOOK_URL }}" # åœ¨ Secrets ä¸­é…ç½®é£ä¹¦æˆ–ä¼å¾®åœ°å€

jobs:
  build:
    name: Sync Images
    runs-on: ubuntu-latest
    steps:
      # å¼ºçƒˆå»ºè®®åœ¨ç¬¬ä¸€æ­¥æ·»åŠ éªŒè¯ï¼Œç¡®è®¤è¿è¡Œå™¨ç±»å‹
      - name: éªŒè¯è¿è¡Œå™¨ç¯å¢ƒ
        run: |
          echo "=== è¿è¡Œå™¨ç¯å¢ƒæŠ¥å‘Š ==="
          echo "è¿è¡Œå™¨ç¯å¢ƒï¼š${{ runner.environment }}"
          echo "è¿è¡Œå™¨åç§°ï¼š${{ runner.name }}"
          echo "è¿è¡Œå™¨æ ‡ç­¾ï¼š${{ toJson(runner.labels) }}"
          
          # å†³å®šæ€§æ£€æŸ¥ï¼šå¦‚æœæ˜¯è‡ªæ‰˜ç®¡ç¯å¢ƒï¼Œç«‹å³å¤±è´¥
          if [ "${{ runner.environment }}" == "self-hosted" ]; then
            echo "âŒ ä¸¥é‡é”™è¯¯ï¼šæ£€æµ‹åˆ°è‡ªæ‰˜ç®¡è¿è¡Œå™¨ (self-hosted)ã€‚"
            echo "è¿™æ„å‘³ç€æ‚¨çš„ 'ubuntu-latest' æ ‡ç­¾ä»è¢«æŸä¸ªè‡ªæ‰˜ç®¡è¿è¡Œå™¨åŒ¹é…ã€‚"
            echo "è¯·ç«‹å³æ£€æŸ¥å¹¶åˆ é™¤æ‚¨è´¦æˆ·ä¸‹æ ‡è®°ä¸º 'ubuntu-latest' çš„è‡ªæ‰˜ç®¡è¿è¡Œå™¨ã€‚"
            exit 1
          fi
          
          echo "âœ… å½“å‰è¿è¡Œäº GitHub æ‰˜ç®¡çš„è¿è¡Œå™¨ (${{ runner.os }})ã€‚"
          echo "å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"
          echo "å¯ç”¨ç£ç›˜ç©ºé—´ï¼š"
          df -h
          
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: 'true'
          remove-haskell: 'true'
          build-mount-path: '/var/lib/docker/'

      - name: Restart docker
        run: sudo service docker restart

        
      - name: Sync and Push to Aliyun
        id: sync_step
        run: |
          echo "$ALIYUN_REGISTRY_PASSWORD" | docker login -u "$ALIYUN_REGISTRY_USER" --password-stdin "$ALIYUN_REGISTRY"
          
          SYNC_SUMMARY=""
          SUCCESS_COUNT=0
          FAILURE_COUNT=0
          
          # ç¬¬ä¸€æ­¥ï¼šé¢„å¤„ç†ï¼Œæ‰¾å‡ºé‡åé•œåƒ
          declare -A duplicate_images
          declare -A temp_map
          while IFS= read -r line || [ -n "$line" ]; do
              # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
              [[ -z "$line" ]] && continue
              if echo "$line" | grep -q '^\s*#'; then
                  continue
              fi
              
              # è·å–é•œåƒçš„å®Œæ•´åç§°ï¼Œä¾‹å¦‚ kasmweb/nginx:1.25.3
              raw_image=$(echo "$line" | awk '{print $NF}')
              # å°†@sha256:ç­‰å­—ç¬¦åˆ é™¤
              image="${raw_image%%@*}"
              # è·å–é•œåƒå:ç‰ˆæœ¬å· ä¾‹å¦‚ nginx:1.25.3
              image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
              # è·å–å‘½åç©ºé—´ ä¾‹å¦‚ kasmwebï¼ˆæ³¨æ„ï¼šdocker.io/nginx ä¼šæŠŠ docker.io å½“æˆå‘½åç©ºé—´ï¼‰
              name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
              # è¿™é‡Œä¸è¦æ˜¯ç©ºå€¼å½±å“åˆ¤æ–­
              name_space="${name_space}_"
              # è·å–é•œåƒåä¾‹å¦‚ nginx
              image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
              
              # å¦‚æœé•œåƒå­˜åœ¨äºæ•°ç»„ä¸­ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦æœ‰é‡åå†²çª
              if [[ -n "${temp_map[$image_name]}" ]]; then
                   # å¦‚æœ temp_map å·²ç»å­˜åœ¨é•œåƒåï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯åŒä¸€å‘½åç©ºé—´
                   if [[ "${temp_map[$image_name]}" != "$name_space" ]]; then
                      duplicate_images[$image_name]="true"
                   fi
              else
                  # å­˜é•œåƒçš„å‘½åç©ºé—´
                  temp_map[$image_name]="$name_space"
              fi       
          done < images.txt

          # ç¬¬äºŒæ­¥ï¼šæ‰§è¡ŒåŒæ­¥
          while IFS= read -r line || [ -n "$line" ]; do
              # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
              [[ -z "$line" ]] && continue
              if echo "$line" | grep -q '^\s*#'; then
                  continue
              fi
              
              # è·å–åŸå§‹é•œåƒä¿¡æ¯
              raw_image=$(echo "$line" | awk '{print $NF}')
              # å°†@sha256:ç­‰å­—ç¬¦åˆ é™¤
              image="${raw_image%%@*}"
              
              # è·å–é•œåƒå:ç‰ˆæœ¬å· ä¾‹å¦‚ nginx:1.25.3
              image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
              # è·å–å‘½åç©ºé—´
              name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
              # è·å–é•œåƒåä¾‹ ä¾‹å¦‚ nginx
              image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
              
              # æå–å¹³å°æ¶æ„ä¿¡æ¯
              platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
              
              # å¦‚æœå­˜åœ¨æ¶æ„ä¿¡æ¯ å°†æ¶æ„ä¿¡æ¯æ‹¼åˆ°é•œåƒåç§°å‰é¢
              if [ -z "$platform" ]; then
                  platform_prefix=""
              else
                  platform_prefix="${platform//\//_}_"
              fi
              
              name_space_prefix=""
              # å¦‚æœé•œåƒåé‡åä¸”å‘½åç©ºé—´ä¸åŒ
              if [[ -n "${duplicate_images[$image_name]}" ]]; then
                 # å¦‚æœå‘½åç©ºé—´éç©ºï¼Œå°†å‘½åç©ºé—´åŠ åˆ°å‰ç¼€
                 if [[ -n "${name_space}" ]]; then
                    name_space_prefix="${name_space}_"
                 fi
              fi
              
              # æ„é€ ç›®æ ‡é•œåƒåç§°
              new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$platform_prefix$name_space_prefix$image_name_tag"
              
              # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
              if skopeo inspect docker://$new_image --creds "$ALIYUN_REGISTRY_USER:$ALIYUN_REGISTRY_PASSWORD" > /dev/null 2>&1; then
                  echo ">>> Skip: $image_name_tag"
                  continue
              fi

              # æ‰§è¡ŒåŒæ­¥ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
              if docker pull "$image" && docker tag "$image" "$new_image" && docker push "$new_image"; then
                  docker rmi "$image" "$new_image"
                  SYNC_SUMMARY="${SYNC_SUMMARY}\nâœ¨ ${image_name_tag}"
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                  SYNC_SUMMARY="${SYNC_SUMMARY}\nğŸš¨ ${image_name_tag} (æ¨é€å¤±è´¥)"
                  FAILURE_COUNT=$((FAILURE_COUNT + 1))
              fi
          done < images.txt

          # å†™å…¥ç¯å¢ƒå˜é‡ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
          echo "SUCCESS_COUNT=$SUCCESS_COUNT" >> $GITHUB_ENV
          echo "FAILURE_COUNT=$FAILURE_COUNT" >> $GITHUB_ENV
          {
            echo 'SYNC_RESULT<<EOF'
            echo -e "$SYNC_SUMMARY"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: å‘é€ Webhook é€šçŸ¥
        if: always()
        run: |
          if [ -z "${{ secrets.WEBHOOK_URL }}" ]; then exit 0; fi

          S_COUNT=${{ env.SUCCESS_COUNT }}
          F_COUNT=${{ env.FAILURE_COUNT }}

          # 1. åˆ¤å®šæ ‡é¢˜å’Œä¸»çŠ¶æ€
          if [ "$F_COUNT" -gt 0 ]; then
              TITLE="âŒ é˜¿é‡Œäº‘é•œåƒåŒæ­¥å¤±è´¥"
              CONTENT="âš ï¸ è­¦å‘Šï¼šæœ‰ $F_COUNT ä¸ªé•œåƒåŒæ­¥å‡ºç°å¼‚å¸¸ï¼Œè¯·åŠæ—¶æ£€æŸ¥ã€‚"
          elif [ "$S_COUNT" -gt 0 ]; then
              TITLE="âœ… é˜¿é‡Œäº‘é•œåƒåŒæ­¥æˆåŠŸ"
              CONTENT="æœ¬æ¬¡æ–°å¢åŒæ­¥é•œåƒå¦‚ä¸‹ï¼š"
          else
            # å¦‚æœå…¨æ˜¯è·³è¿‡ï¼Œä¸ºäº†ä¸éªšæ‰°ï¼Œå¯ä»¥é€‰æ‹©ä¸å‘ï¼Œæˆ–è€…å‘ä¸€æ¡ç®€æ´çš„
            TITLE="â˜• åŒæ­¥ä»»åŠ¡å®Œæˆ (æ— æ–°é•œåƒ)"
            CONTENT="æ£€æµ‹åˆ° images.txt ä¸­æš‚æ— æ–°é•œåƒéœ€è¦åŒæ­¥ã€‚"
          fi

          # 2. ç»„è£…æœ€ç»ˆæ–‡æœ¬ (ç§»é™¤è·³è¿‡çš„åˆ—è¡¨ï¼Œåªæ˜¾ç¤º SYNC_RESULT)
          RAW_TEXT=$(cat <<EOF
          $TITLE
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          $CONTENT
          ${{ env.SYNC_RESULT }}

          ğŸ“Š ç»Ÿè®¡: æˆåŠŸ $S_COUNT | å¤±è´¥ $F_COUNT
          ğŸ”— è¯¦æƒ…: [æŸ¥çœ‹ GitHub Action æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )

          # 3. å‘é€
          JSON_PAYLOAD=$(jq -n --arg msg "$RAW_TEXT" '{"msg_type":"text","content":{"text":$msg}}')
          curl -X POST -H "Content-Type: application/json" -d "$JSON_PAYLOAD" "${{ secrets.WEBHOOK_URL }}"
